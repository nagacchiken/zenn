---
title: "EC2からECSへのマイグレーション"
emoji: "📘"
type: "tech"
topics: []
published: false
---

## 利用している技術スタックなど

ここに羅列

## 移行前の構成

ここに構成図（モバイルアプリまで）

## これまでの課題

- デプロイのアーキテクチャが複雑
    - 引継ぎした時点でデプロイの機構はシェル芸のような作りになっておりブラックボックス化（Makefileを実行するとなんかいい感じにCodeDeployが起動してインプレースデプロイされている…？🤔）
- サーバーのメンテナンス人的負荷
    - OSやミドルウェアのバージョン更新に割く人的な資源が足りない（チームにはバックエンドは私含めて2人しかおらず、さらにインフラができるのが実質私一人しかいなかった）

## 解決できた課題

- デプロイ機構の整理
    - ECR へのイメージのプッシュ → ECSのタグを変更してデプロイというシンプルな実装に
- サーバーのメンテナンス人的負荷
    - → ホストの管理はAWS側に異常することにより人的な管理コストの削減ができる

## 実装した内容

移行後の構成図や設計のパターンについて記述する

## 学んだこと

- 一度に全てやろうとしない、そして過度に綺麗に設計しようとしない
    - 最初は頭でっかちになりマイクロアーキテクチャをとことんやろうとした。（DBをそれぞれ用意してカプセル化して…etc）でもすでに運用されているシステムはすでにモノリシックなもので動いている。簡単に分割できそうなところだけ分割してある程度の割切りが必要と感じた。コンテナ化できた時点で可搬性は上がっている。そのため後で少しずつまたアーキテクチャを適切に実装し直していけばいいと考えるようになった。

## 移行計画

- ALBのリスナールールを利用したB/Gデプロイの実施
- モバイルチームにお願いし、特別なドメインを用意しそこにアクセスしてもらう。そして本番環境でトラフィックを切り替える前のグリーン環境にアクセスできるようにして本番環境を使ったテストを実施。（言い回しがおかしいので後で直す）


## 大変だったところ、失敗したところ

- Firelensの実装。これまで自分でfluentbitを実装したことがなかった。EC2で利用してたものをそのまま移植すればいいんじゃね？とか考えていたらまったくそんなことはなく、一から全部書き直しすることになった。ちなみに `*-firelens-*`とかで引っ掛けられる
- パブリックなコンテナイメージをそのままプルして使い、ステージングでサービスが落ちる
    - ステージング環境でのテスト時にたまたまDockerHubで障害が発生。ECSで利用していたコンテナイメージの一部は直接DockerHubからプルしてしまっていたため、コンテナが起動できなくなってしまった。自身でカスタマイズしていないイメージであっても必ずECRでコンテナイメージを作成するが吉。そしてDockerHubは時間あたりのイメージのプル制限があるのでECR Galleriesを優先して利用するようにした