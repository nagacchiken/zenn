---
title: "EC2からECSへのマイグレーションをする　"
emoji: "📘"
type: "tech"
topics: ["CICD", "ECS"]
published: false
---

AmazonLinux2は2026年6月EOLを迎えます。このタイミングでサービスのEC2をECS Fargateへ移行を実施しました。躓いたところ、課題に感じたところについてまとめます。

~~ちなみに元々開発を外注していたものを内製化したサービスです。いざ蓋を開けてみるとマイナーなフレームワークをフォークしたオレオレフレームワークや、自分たちで作ったであろう開発ツールなどのオンパレード…　なければ作るというスタンスは実にエンジニアらしいものですが、ドキュメントもろくに残ってないし保守する方の都合も考えてほしい~~

## 移行前の構成

#### サーバーサイド

- EC2 (AmazonLinux2)
- Chef (mitamae)
- CloudFormation
- Go言語

#### フロントエンド（モバイルアプリ）

`※今回はサーバーサイドの話なので割愛`

- iOS (swift)
- Andcoid (kotlin)

ここに構成図（モバイルアプリまで）

## EC2運用時の課題

### デプロイのアーキテクチャが複雑

- デプロイは全て手動で行っていた。さらに先人達によって作られた秘伝のタレツールで行われていた（Makefileを実行するとなんかいい感じにCodeDeployが起動して、さらによくわからんツールがインプレースデプロイしてくれている…？🤔）

### サーバーのメンテナンス人的負荷

- OSやミドルウェアのバージョン更新に割く人的な資源が足りない（チームにはバックエンドは私含めて2人しかおらず、さらにインフラができるのが実質私一人しかいなかった）

## 選定した技術と理由

- デプロイ機構の整理・自動化
    - ECR へのイメージのプッシュ → ECSのタグを変更してデプロイというシンプルな実装に。そしてGitHub Actionsを利用したCI/CDを実現
- サーバーのメンテナンス人的負荷
    - → ホストの管理はAWS側に異常することにより人的な管理コストの削減ができる

## 実装した内容

移行後の構成図や設計のパターンについて記述する

## 学んだこと

- 一度に全てやろうとしない、そして過度に綺麗に設計しようとしない
    - 最初は頭でっかちになりマイクロアーキテクチャをとことんやろうとした。（DBをそれぞれ用意してカプセル化して…etc）でもすでに運用されているシステムはすでにモノリシックなもので動いている。簡単に分割できそうなところだけ分割してある程度の割切りが必要と感じた。コンテナ化できた時点で可搬性は上がっている。そのため後で少しずつまたアーキテクチャを適切に実装し直していけばいいと考えるようになった。

## 移行計画

- ALBのリスナールールを利用したB/Gデプロイの実施
- モバイルチームにお願いし、特別なドメインを用意しそこにアクセスしてもらう。そして本番環境でトラフィックを切り替える前のグリーン環境にアクセスできるようにして本番環境を使ったテストを実施。（言い回しがおかしいので後で直す）


## 大変だったところ、失敗したところ

- Firelensの実装。これまで自分でfluentbitを実装したことがなかった。EC2で利用してたものをそのまま移植すればいいんじゃね？とか考えていたらまったくそんなことはなく、一から全部書き直しすることになった。ちなみに `*-firelens-*`とかで引っ掛けられる
- パブリックなコンテナイメージをそのままプルして使い、ステージングでサービスが落ちる
    - ステージング環境でのテスト時にたまたまDockerHubで障害が発生。ECSで利用していたコンテナイメージの一部は直接DockerHubからプルしてしまっていたため、コンテナが起動できなくなってしまった。自身でカスタマイズしていないイメージであっても必ずECRでコンテナイメージを作成するが吉。そしてDockerHubは時間あたりのイメージのプル制限があるのでECR Galleriesを優先して利用するようにした