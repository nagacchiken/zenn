---
title: "CloudFormationからCDKへ移行する"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["CloudFormation","CDK"]
published: false
---



これまでインフラエンジニアがAWSのリソースをCloudFormationでリソース管理していたものをアプリケーションエンジニアで管理する必要が出てきた

インフラのコストとしてcfnは認識コストが重いからCDKに移行したいと考えた

CDKへの移行にはcdk migrateという素晴らしいコマンドが用意されているので、これを利用します。


## 大まかな流れ

1. cfn-flipによるCloudFormationの整形

2. cdk migrate の実行

3. L1コンストラクタをL2コンストラクタに変換 


## cfn-flipの実行

### cfn-flipとは

cloudformationをいい感じに整形してくれるすごいやつ。
https://github.com/awslabs/aws-cfn-template-flip

cfnが省略形で記述されていたりするとcdk migrateコマンドを実行したときにうまく変換をしてくれません。そこでcfn-flipを利用して綺麗な形式に予め変換してやる必要があります。

利用にはpythonとpipが必要です。環境の用意が面倒だったので今回はコンテナを用意して実行。

Dockerfile

```Dockerfile
FROM python:latest

RUN pip install --upgrade pip
RUN pip install cfn-flip

ENTRYPOINT [ "cfn-flip" ]
```

イメージをビルドします。
```
docker image build --tag cfn-pip:latest .
```

コンテナを用意できたらcfn-flipを実行。
```
docker container run --rm -v .:/workspace -w /workspace cfn-pip:latest -i yaml -o yaml target.yaml new-target.yaml -l
```

## cdk migrate の実行

cdk migrateコマンドを実行していきます。CDKの言語はTypeScriptを選択。CDKのデファクトスタンダードはTypeScriptのようなので、万一のトラブルシューティングも楽なんじゃないかと思い。また、プロジェクト自体はGoで記述しているのですが、毎度CDKの記事を参照するたびに頭の中で言語を変換して読み替えるコストが高いと思いTypeScriptに寄せる判断をしました。
```
cdk migrate --stack-name <your-target-stack-name> --language typescript --from-path your-target.yaml
```

変換されたものは型チェックで多々引っかかるので、手動で修正していきます。
~~というかリソースによって数字が文字列扱いだったり整数扱いになってたりするCDKの型のほうがおかしい、どうなってんだ~~

cdk diffを実行して差分に問題ないかチェックしていきましょう


## L1コンストラクタをL2コンストラクタに変換 

L1コンストラクタからL2コンストラクタに変換していきます。CDKへの移行自体はcdk migrateを実行して完了しているのですが、CDKのいいところはL2コンストラクタにあります。

L1コンストラクタはCloudFormationの記述をそのままプログラミング言語で表したものになります。Cfn~というプリフィックスで始まります。それに対しL2コンストラクタとはL1コンストラクタを抽象化し利用しやすくしたものです。L1コンストラクタであれば都度IAMロールなど付随したリソースを自身で定義してやる必要があるのに対し、L2コンストラクタであれば自動的に作成してくれます。

なお、この自動で作ってくれているという部分を忘れると知らぬうちにリソースを立てて痛い目を見ます。便利ですが自分が何を操作しているのかはしっかり認識しましょう。


そのままL2へ変換しようとするとリソースがreplaceされてしまいます。
したがって、cdk diff --verbose で差分を確認しながらreplace ないし may be replace と表記されたリソースに対しoverrideLogicalIdを使って論理IDを統一したままL2コンストラクタに変換していきます。